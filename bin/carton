#!/usr/bin/env bash

if [ -z "$EMACS" ] || [ -z "$(which $EMACS)" ] ; then
  EMACS=emacs
fi

# Use an environment variable to pass the name to the Emacs process.  We cannot
# give it as command line argument because that would cause Emacs to visit the
# file, printing a lot of superfluous messages.
export CARTON_STARTUP_SCRIPT="$0"
CARTON_PATH=$($EMACS -Q --batch --eval '(princ (file-truename (getenv "CARTON_STARTUP_SCRIPT")))')

if [ -z "$CARTON_DIR" -o ! -d "$CARTON_DIR" ] ; then
  CARTON_DIR="$(dirname $(dirname $CARTON_PATH))"
fi
TEMPLATE_DIR="$CARTON_DIR/templates"

CARTON_EL="$CARTON_DIR/carton.el"

if [[ $# -eq 0 ]]; then
  COMMAND=install
else
  if [[ $1 == "package" ]]; then
    COMMAND=package
  elif [[ $1 == "install" ]]; then
    COMMAND=install
  elif [[ $1 == "update" ]]; then
    COMMAND=update
  elif [[ $1 == "exec" ]]; then
    EMACSLOADPATH=$($EMACS -Q --batch --eval '(message (mapconcat (quote identity) (append (file-expand-wildcards "elpa/*" t) load-path) ":"))' 2>&1) exec "${@:2}"
  else
    if [[ $1 == "init" ]]; then
      cat $TEMPLATE_DIR/init.tpl > Carton
    elif [ "$1" == "-h" -o "$1" == "--help" ]; then
      cat $TEMPLATE_DIR/usage.tpl
    else
      cat $TEMPLATE_DIR/usage.tpl
    fi

    exit 1
  fi
fi

if [[ -n $COMMAND ]]; then
  $EMACS --batch --load $CARTON_EL --eval "(progn (carton-setup \"${PWD}\") (carton-${COMMAND}))"
fi
