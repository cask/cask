#!/usr/bin/env bash

if [ -z "$EMACS" ] || [ -z "`which $EMACS`" ] ; then
  EMACS=emacs
fi

if [ -z "$CARTON_DIR" -o ! -d "$CARTON_DIR" ] ; then
  CARTON_DIR="$(dirname $(dirname $(readlink -f $0)))"
fi
TEMPLATE_DIR="$CARTON_DIR/templates"

CARTON_EL="$CARTON_DIR/carton.el"

if [[ $# -eq 0 ]]; then
  COMMAND=install
else
  if [[ $1 == "package" ]]; then
    COMMAND=package
  elif [[ $1 == "install" ]]; then
    COMMAND=install
  elif [[ $1 == "update" ]]; then
    COMMAND=update
  elif [[ $1 == "exec" ]]; then
    EMACSLOADPATH=$($EMACS -Q --batch --eval '(message (mapconcat (quote identity) (append (file-expand-wildcards "elpa/*" t) load-path) ":"))' 2>&1) exec "${@:2}"
  else
    if [[ $1 == "init" ]]; then
      cat $TEMPLATE_DIR/init.tpl > Carton
    elif [ "$1" == "-h" -o "$1" == "--help" ]; then
      cat $TEMPLATE_DIR/usage.tpl
    else
      cat $TEMPLATE_DIR/usage.tpl
    fi

    exit 1
  fi
fi

if [[ -n $COMMAND ]]; then
  $EMACS --batch --load $CARTON_EL --eval "(progn (carton-setup \"${PWD}\") (carton-${COMMAND}))"
fi
